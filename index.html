<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>RTU 실시간 온도 모니터링</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f6fa;
      margin: 0;
      text-align: center;
      overflow-x: hidden;
    }
    h2 { margin-top: 20px; color: #2c3e50; }

    .map-wrapper {
      width: 90%; max-width: 900px; margin: 20px auto;
      border-radius: 10px; box-shadow: 0 0 8px #bbb;
      overflow: hidden; position: relative; background: #fff; cursor: grab;
    }
    #layout { position: relative; transform-origin: center center; transition: transform 0.1s ease-out; }
    #layout img { width: 100%; border-radius: 10px; display: block; }

    .marker {
      position: absolute; width: 28px; height: 28px; border-radius: 50%;
      background: gray; color: white; display: flex; justify-content: center;
      align-items: center; font-size: 12px; cursor: pointer;
      transform: translate(-50%, -50%); transition: 0.2s;
    }
    .marker:hover { transform: translate(-50%, -50%) scale(1.2); }
    .marker.active { background: #e74c3c !important; box-shadow: 0 0 10px #e74c3c; }

    .popup {
      position: absolute; backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.75); border-radius: 12px;
      padding: 10px 14px; font-size: 0.9rem; color: #333;
      box-shadow: 0 6px 15px rgba(0,0,0,0.15); z-index: 10;
    }

    .blue { color: #3498db; }
    .black { color: #2c3e50; }
    .red { color: #e74c3c; }

    .table-container {
      width: 90%; max-width: 900px; margin: 30px auto 60px auto;
      background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #eee; text-align: center; }
    th { background: #3498db; color: white; position: sticky; top: 0; z-index: 2; }

    button.select-btn, button.reset-btn {
      padding: 4px 8px; border: none; border-radius: 5px; cursor: pointer;
      font-size: 0.8rem; color: white; transition: 0.2s;
    }
    button.select-btn { background: #3498db; }
    button.select-btn:hover { background: #2980b9; }

    .reset-btn { background: #3498db; margin-left: 5px; }
    .reset-btn.active { background: #e74c3c !important; }
  </style>
</head>
<body>
  <h2>RTU 실시간 온도 모니터링</h2>

  <div class="map-wrapper" id="mapWrapper">
    <div id="layout"><img src="layout.jpg" alt="Layout" id="layout-img"></div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>선택 / 리셋</th>
          <th>유닛</th>
          <th>증발기 온도 (°F)</th>
          <th>공급기 온도 (°F)</th>
        </tr>
      </thead>
      <tbody id="unit-table"></tbody>
    </table>
  </div>

  <script>
    // MQTT 설정
    const client = mqtt.connect("wss://3f34159555984b35a539f803505dc858.s1.eu.hivemq.cloud:8884/mqtt", {
      username: "Goodmansystemllc",
      password: "Good7071**"
    });

    const mapWidth = 8192, mapHeight = 5586;
    const tableBody = document.getElementById("unit-table");
    const layoutDiv = document.getElementById("layout");
    const temps = {}, unitIdMap = {};
    let activePopup = null;

    // 전체 UNIT 좌표 (35개)
    const unitMarkersData = [
      {"unit": "UNIT1", "x1": 402, "y1": 2431, "x2": 488, "y2": 2533},
      {"unit": "UNIT2", "x1": 546, "y1": 2424, "x2": 655, "y2": 2525},
      {"unit": "UNIT3", "x1": 1053, "y1": 2446, "x2": 1263, "y2": 2554},
      {"unit": "UNIT4", "x1": 1596, "y1": 2431, "x2": 1769, "y2": 2554},
      {"unit": "UNIT5", "x1": 2023, "y1": 2446, "x2": 2175, "y2": 2540},
      {"unit": "UNIT6", "x1": 2840, "y1": 2438, "x2": 3072, "y2": 2547},
      {"unit": "UNIT7", "x1": 394, "y1": 326, "x2": 510, "y2": 434},
      {"unit": "UNIT8", "x1": 742, "y1": 311, "x2": 959, "y2": 398},
      {"unit": "UNIT9", "x1": 1038, "y1": 304, "x2": 1219, "y2": 405},
      {"unit": "UNIT10", "x1": 1321, "y1": 318, "x2": 1523, "y2": 412},
      {"unit": "UNIT11A", "x1": 3101, "y1": 87, "x2": 3224, "y2": 174},
      {"unit": "UNIT12", "x1": 2196, "y1": 304, "x2": 2399, "y2": 427},
      {"unit": "UNIT13", "x1": 568, "y1": 550, "x2": 633, "y2": 630},
      {"unit": "UNIT14", "x1": 554, "y1": 876, "x2": 640, "y2": 941},
      {"unit": "UNIT15", "x1": 4020, "y1": 456, "x2": 4100, "y2": 535},
      {"unit": "UNIT16", "x1": 4375, "y1": 456, "x2": 4461, "y2": 535},
      {"unit": "UNIT17", "x1": 4613, "y1": 434, "x2": 4722, "y2": 514},
      {"unit": "UNIT18", "x1": 3535, "y1": 760, "x2": 3673, "y2": 854},
      {"unit": "UNIT19", "x1": 4085, "y1": 753, "x2": 4215, "y2": 868},
      {"unit": "UNIT20", "x1": 4613, "y1": 767, "x2": 4736, "y2": 847},
      {"unit": "UNIT21", "x1": 5142, "y1": 745, "x2": 5279, "y2": 868},
      {"unit": "UNIT22", "x1": 5641, "y1": 731, "x2": 5815, "y2": 868},
      {"unit": "UNIT23", "x1": 4606, "y1": 1389, "x2": 4729, "y2": 1476},
      {"unit": "UNIT24", "x1": 5402, "y1": 1375, "x2": 5532, "y2": 1469},
      {"unit": "UNIT25", "x1": 3542, "y1": 1983, "x2": 3694, "y2": 2098},
      {"unit": "UNIT26", "x1": 4071, "y1": 1983, "x2": 4237, "y2": 2091},
      {"unit": "UNIT27", "x1": 4606, "y1": 1968, "x2": 4751, "y2": 2091},
      {"unit": "UNIT28", "x1": 5142, "y1": 1983, "x2": 5279, "y2": 2077},
      {"unit": "UNIT29", "x1": 5684, "y1": 1961, "x2": 5822, "y2": 2077},
      {"unit": "UNIT30", "x1": 3535, "y1": 1585, "x2": 3731, "y2": 1700},
      {"unit": "UNIT31", "x1": 4092, "y1": 1650, "x2": 4252, "y2": 1766},
      {"unit": "UNIT32", "x1": 6263, "y1": 745, "x2": 6394, "y2": 897},
      {"unit": "UNIT33", "x1": 6336, "y1": 1389, "x2": 6473, "y2": 1556},
      {"unit": "UNIT34", "x1": 6314, "y1": 1917, "x2": 6415, "y2": 2048},
      {"unit": "UNIT11B", "x1": 3014, "y1": 333, "x2": 3181, "y2": 405}
    ];

    function getColor(role,temp){
      temp=parseFloat(temp);
      if(isNaN(temp))return"black";
      if(role==="evap"){if(temp<32)return"blue";else if(temp<=65)return"black";else return"red";}
      else{if(temp<=76)return"blue";else if(temp<=80)return"black";else return"red";}
    }

    // 리셋 명령 발행
    function sendReset(unitName){
      const btn=document.getElementById(`reset-${unitName}`);
      if(!btn)return;
      client.publish(`ac/reset/${unitName}`,"reset");
      btn.classList.add('active'); btn.disabled=true; btn.textContent='리셋 중...';
      setTimeout(()=>{btn.classList.remove('active');btn.disabled=false;btn.textContent='리셋';},60000);
    }

    function createMarkers(){
      unitMarkersData.forEach(u=>{
        const cx=(u.x1+u.x2)/2, cy=(u.y1+u.y2)/2;
        const left=(cx/mapWidth)*100, top=(cy/mapHeight)*100;
        const name=u.unit, id=name.replace('UNIT','');
        const marker=document.createElement('div');
        marker.className='marker'; marker.id=`marker-${name}`;
        marker.textContent=id; marker.style.left=`${left}%`; marker.style.top=`${top}%`;
        marker.addEventListener("click",()=>showPopup(name,marker));
        layoutDiv.appendChild(marker);
      });
    }

    function setupUnits(){
      unitMarkersData.forEach(u=>{
        const name=u.unit, id=name.replace('UNIT','');
        const tr=document.createElement('tr');
        tr.id=`row-${name}`;
        tr.innerHTML=`
          <td>
            <button class="select-btn" onclick="showPopup('${name}',document.getElementById('marker-${name}'))">선택</button>
            <button class="reset-btn" id="reset-${name}" onclick="sendReset('${name}')">리셋</button>
          </td>
          <td>${id}</td>
          <td><span id="evap-${name}" class="black">--</span></td>
          <td><span id="supply-${name}" class="black">--</span></td>`;
        tableBody.appendChild(tr);
      });
    }

    document.getElementById("layout-img").onload=()=>{createMarkers();setupUnits();};
    if(document.getElementById("layout-img").complete){createMarkers();setupUnits();}

    client.on("connect",()=>console.log("✅ MQTT 연결됨"));
    client.on("message",(topic,message)=>{
      try{
        const data=JSON.parse(message.toString());
        const role=topic.includes("evap")?"evap":"supply";
        const id=topic.split("-").pop();
        const name=`UNIT${id}`;
        const temp=data.temp_f;
        const el=document.getElementById(`${role}-${name}`);
        if(el){el.textContent=temp.toFixed(1);el.className=getColor(role,temp);}
      }catch(e){console.error(e);}
    });

    function showPopup(unitName,marker){
      if(activePopup)activePopup.remove();
      const popup=document.createElement("div");
      popup.className="popup"; popup.dataset.unit=unitName;
      popup.innerHTML=`<h4>${unitName}<button class="close-btn" onclick="this.parentElement.parentElement.remove()">✕</button></h4>`;
      popup.style.left=marker.style.left; popup.style.top=marker.style.top; popup.style.transform='translate(-50%,25px)';
      layoutDiv.appendChild(popup); activePopup=popup;
    }
  </script>
</body>
</html>
