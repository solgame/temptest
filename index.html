<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>RTU 실시간 온도 모니터링</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f6fa;
      margin: 0;
      text-align: center;
      overflow-x: hidden;
    }
    h2 {
      margin-top: 20px;
      color: #2c3e50;
    }

    /* ---------------- 지도 컨테이너 ---------------- */
    .map-wrapper {
      width: 90%;
      max-width: 900px;
      margin: 20px auto;
      border-radius: 10px;
      box-shadow: 0 0 8px #bbb;
      overflow: hidden;
      position: relative;
      background: #fff;
      cursor: grab;
    }
    #layout {
      position: relative;
      transform-origin: center center;
      transition: transform 0.1s ease-out;
    }
    #layout img {
      width: 100%;
      border-radius: 10px;
      display: block;
    }

    /* 마커 스타일 */
    .marker {
      position: absolute;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: gray;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      /* 마커를 중앙에 정렬하기 위해 추가 */
      transform: translate(-50%, -50%);
    }
    .marker:hover { transform: translate(-50%, -50%) scale(1.2); }
    .marker.active {
      background: #e74c3c !important;
      box-shadow: 0 0 10px #e74c3c;
    }

    /* 팝업 카드 */
    .popup {
      position: absolute;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.75);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 12px 14px 10px 14px;
      font-size: 0.9rem;
      color: #333;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
      min-width: 150px;
      z-index: 10;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, 0); }
      to { opacity: 1; transform: translate(-50%, 10px); }
    }

    .popup h4 {
      margin: 0;
      color: #2c3e50;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .close-btn {
      border: none;
      background: none;
      color: #555;
      font-size: 1rem;
      cursor: pointer;
      padding: 0;
      margin-left: 10px;
      transition: 0.2s;
    }
    .close-btn:hover { color: #e74c3c; transform: scale(1.2); }

    .popup .temp {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      margin-top: 5px;
    }

    .blue { color: #3498db; }
    .black { color: #2c3e50; }
    .red { color: #e74c3c; }

    /* ---------------- 표 ---------------- */
    .table-container {
      width: 90%;
      max-width: 900px;
      margin: 30px auto 60px auto;
      max-height: 450px;
      overflow-y: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #3498db;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    td { text-align: center; }
    tr:last-child td { border-bottom: none; }

    .highlight {
      background: #fff9c4;
      transition: background 0.5s;
    }

    button.select-btn {
      padding: 4px 8px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: 0.2s;
    }
    button.select-btn:hover {
      background: #2980b9;
    }

    /* 리셋 버튼 스타일 추가 */
    button.reset-btn {
      padding: 4px 8px;
      background: #e74c3c; /* 평상시: 빨간색 */
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: 0.3s;
      width: 55px; /* 버튼 크기 고정 */
    }
    button.reset-btn:hover {
      background: #c0392b;
    }
    /* 리셋 진행 중 스타일 */
    button.reset-btn.resetting {
      background: #f39c12; /* 리셋 중: 주황색 */
      cursor: not-allowed;
      animation: pulsate 1s infinite alternate; /* 깜빡임 효과 */
    }
    
    @keyframes pulsate {
        from { opacity: 1; }
        to { opacity: 0.7; }
    }
  </style>
</head>
<body>
  <h2>RTU 실시간 온도 모니터링</h2>

  <div class="map-wrapper" id="mapWrapper">
    <div id="layout">
      <img src="layout.jpg" alt="Layout" id="layout-img">
      </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>선택</th>
          <th>유닛</th>
          <th>증발기 온도 (°F)</th>
          <th>공급기 온도 (°F)</th>
          <th>리셋</th> </tr>
      </thead>
      <tbody id="unit-table"></tbody>
    </table>
  </div>

  <script>
    // ---------------- MQTT SETUP ----------------
    const client = mqtt.connect("wss://3f34159555984b35a539f803505dc858.s1.eu.hivemq.cloud:8884/mqtt", {
      username: "Goodmansystemllc",
      password: "Good7071**"
    });

    // ---------------- UNIT DATA (From image_map_markers.json) ----------------
    const unitMarkersData = [
      {"unit": "UNIT1", "x1": 402, "y1": 2431, "x2": 488, "y2": 2533},
      {"unit": "UNIT2", "x1": 546, "y1": 2424, "x2": 655, "y2": 2525},
      {"unit": "UNIT3", "x1": 1053, "y1": 2446, "x2": 1263, "y2": 2554},
      {"unit": "UNIT4", "x1": 1596, "y1": 2431, "x2": 1769, "y2": 2554},
      {"unit": "UNIT5", "x1": 2023, "y1": 2446, "x2": 2175, "y2": 2540},
      {"unit": "UNIT6", "x1": 2840, "y1": 2438, "x2": 3072, "y2": 2547},
      {"unit": "UNIT7", "x1": 394, "y1": 326, "x2": 510, "y2": 434},
      {"unit": "UNIT8", "x1": 742, "y1": 311, "x2": 959, "y2": 398},
      {"unit": "UNIT9", "x1": 1038, "y1": 304, "x2": 1219, "y2": 405},
      {"unit": "UNIT10", "x1": 1321, "y1": 318, "x2": 1523, "y2": 412},
      {"unit": "UNIT11A", "x1": 3101, "y1": 87, "x2": 3224, "y2": 174},
      {"unit": "UNIT12", "x1": 2196, "y1": 304, "x2": 2399, "y2": 427},
      {"unit": "UNIT13", "x1": 568, "y1": 550, "x2": 633, "y2": 630},
      {"unit": "UNIT14", "x1": 554, "y1": 876, "x2": 640, "y2": 941},
      {"unit": "UNIT15", "x1": 4020, "y1": 456, "x2": 4100, "y2": 535},
      {"unit": "UNIT16", "x1": 4375, "y1": 456, "x2": 4461, "y2": 535},
      {"unit": "UNIT17", "x1": 4613, "y1": 434, "x2": 4722, "y2": 514},
      {"unit": "UNIT18", "x1": 3535, "y1": 760, "x2": 3673, "y2": 854},
      {"unit": "UNIT19", "x1": 4085, "y1": 753, "x2": 4215, "y2": 868},
      {"unit": "UNIT20", "x1": 4613, "y1": 767, "x2": 4736, "y2": 847},
      {"unit": "UNIT21", "x1": 5142, "y1": 745, "x2": 5279, "y2": 868},
      {"unit": "UNIT22", "x1": 5641, "y1": 731, "x2": 5815, "y2": 868},
      {"unit": "UNIT23", "x1": 4606, "y1": 1389, "x2": 4729, "y2": 1476},
      {"unit": "UNIT24", "x1": 5402, "y1": 1375, "x2": 5532, "y2": 1469},
      {"unit": "UNIT25", "x1": 3542, "y1": 1983, "x2": 3694, "y2": 2098},
      {"unit": "UNIT26", "x1": 4071, "y1": 1983, "x2": 4237, "y2": 2091},
      {"unit": "UNIT27", "x1": 4606, "y1": 1968, "x2": 4751, "y2": 2091},
      {"unit": "UNIT28", "x1": 5142, "y1": 1983, "x2": 5279, "y2": 2077},
      {"unit": "UNIT29", "x1": 5684, "y1": 1961, "x2": 5822, "y2": 2077},
      {"unit": "UNIT30", "x1": 3535, "y1": 1585, "x2": 3731, "y2": 1700},
      {"unit": "UNIT31", "x1": 4092, "y1": 1650, "x2": 4252, "y2": 1766},
      {"unit": "UNIT32", "x1": 6263, "y1": 745, "x2": 6394, "y2": 897},
      {"unit": "UNIT33", "x1": 6336, "y1": 1389, "x2": 6473, "y2": 1556},
      {"unit": "UNIT34", "x1": 6314, "y1": 1917, "x2": 6415, "y2": 2048},
      {"unit": "UNIT11B", "x1": 3014, "y1": 333, "x2": 3181, "y2": 405}
    ];

    // 지도 원본 크기 설정 (JSON 좌표의 최대값에 근거하여 정확한 비율 계산)
    const mapWidth = 8192; 
    const mapHeight = 5586; 

    // ---------------- GLOBAL STATE ----------------
    const lastUpdate = {};
    const temps = {};
    let activePopup = null;
    const unitIdMap = {}; // short ID ('1', '11A') -> full unitName ('UNIT1', 'UNIT11A')

    // ---------------- HELPER FUNCTIONS ----------------
    // 색상 로직
    function getColor(role, temp) {
      temp = parseFloat(temp);
      if (isNaN(temp)) return "black";
      if (role === "evap") {
        if (temp < 32) return "blue";
        else if (temp <= 65) return "black";
        else return "red";
      } else {
        if (temp <= 76) return "blue";
        else if (temp <= 80) return "black";
        else return "red";
      }
    }

    const tableBody = document.getElementById("unit-table");
    const layoutDiv = document.getElementById("layout");

    // 맵 마커 생성 및 위치 설정
    function createMarkers() {
      unitMarkersData.forEach(unitData => {
        // Calculate the center coordinates
        const centerX = (unitData.x1 + unitData.x2) / 2;
        const centerY = (unitData.y1 + unitData.y2) / 2;

        // Calculate the percentage position
        const leftPercent = (centerX / mapWidth) * 100;
        const topPercent = (centerY / mapHeight) * 100;

        const unitName = unitData.unit;
        // Display ID: e.g., "UNIT1" -> "1", "UNIT11A" -> "11A"
        const displayId = unitName.replace('UNIT', '');
        
        const marker = document.createElement("div");
        marker.className = "marker";
        marker.id = `marker-${unitName}`;
        marker.textContent = displayId;
        marker.style.left = `${leftPercent}%`;
        marker.style.top = `${topPercent}%`;
        
        // Attach click listener
        marker.addEventListener("click", () => {
          showPopup(unitName, marker);
        });
        
        layoutDiv.appendChild(marker);
      });
    }

    // 표 생성 및 MQTT 구독 설정
    function setupUnits() {
      unitMarkersData.forEach(unitData => {
        const unitName = unitData.unit;
        const displayId = unitName.replace('UNIT', '');
        
        // 1. Map creation for message handling
        unitIdMap[displayId] = unitName;
        
        // 0. 리셋 상태 Topic 구독 추가
        client.subscribe(`ac/status/${unitName}`); 

        // Create table row
        const tr = document.createElement("tr");
        tr.id = `row-${unitName}`;
        tr.innerHTML = `
          <td><button class="select-btn" onclick="showPopup('${unitName}', document.getElementById('marker-${unitName}'))">선택</button></td>
          <td>${displayId}</td>
          <td><span id="evap-${unitName}" class="black">--</span></td>
          <td><span id="supply-${unitName}" class="black">--</span></td>
          <td><button class="reset-btn" id="reset-btn-${unitName}" onclick="requestReset('${unitName}')">리셋</button></td>
        `; // 리셋 버튼 추가
        tableBody.appendChild(tr);

        // 2. Subscribe to MQTT topics using the correct short ID
        client.subscribe(`ac/temperature/evap-${displayId}`); 
        client.subscribe(`ac/temperature/supply-${displayId}`);
        
        if (!temps[unitName]) temps[unitName] = { evap: "--", supply: "--" };
      });
    }
    
    // Start setup when the image is loaded
    document.getElementById("layout-img").onload = () => {
      createMarkers();
      setupUnits();
    };

    // Fallback if the image loads too fast or is cached
    if (document.getElementById("layout-img").complete) {
      createMarkers();
      setupUnits();
    }

    // ---------------- MQTT EVENT HANDLERS ----------------
    client.on("connect", () => {
      console.log("✅ MQTT 연결됨");
    });

    // 데이터 수신
    client.on("message", (topic, message) => {
      try {
        // ---------------- 리셋 상태 처리 로직 ----------------
        if (topic.startsWith("ac/status/")) {
            const unitNameFromStatus = topic.split('/').pop(); // 'UNIT1' 추출
            const status = message.toString(); // 'resetting' 또는 'done'
            
            if (status === 'resetting' || status === 'done') {
                updateResetButtonState(unitNameFromStatus, status);
                console.log(`ℹ️ [${unitNameFromStatus}] 상태: ${status}`);
                return; // 상태 메시지는 온도 데이터가 아니므로 여기서 종료
            }
        }
        // ---------------- 온도 데이터 처리 로직 ----------------

        const data = JSON.parse(message.toString());
        const role = topic.includes("evap") ? "evap" : "supply";
        
        // Topic ID: '1', '11A' 등 짧은 ID 추출
        const topicId = topic.split("-").pop(); 
        
        // full unitName: 'UNIT1', 'UNIT11A'로 변환
        const unitName = unitIdMap[topicId]; 
        
        if (!unitName) {
            console.error(`🔴 Unrecognized Topic ID: ${topicId}. Topic: ${topic}`);
            return; 
        }
        
        const temp = data.temp_f;

        if (!temps[unitName]) temps[unitName] = { evap: "--", supply: "--" };
        temps[unitName][role] = temp.toFixed(1);
        lastUpdate[`${role}-${unitName}`] = Date.now();

        const el = document.getElementById(`${role}-${unitName}`);
        if (el) {
          el.textContent = temp.toFixed(1);
          el.className = getColor(role, temp);
        }
        if (activePopup && activePopup.dataset.unit == unitName) updatePopupContent(unitName);
      } catch (e) {
        console.error("데이터 오류:", e);
      }
    });

    // ---------------- 리셋 버튼 로직 ----------------

    /**
     * 특정 유닛에 리셋 명령을 전송하고 버튼 상태를 업데이트합니다.
     * @param {string} unitName - 전체 유닛 이름 (예: 'UNIT1')
     */
    function requestReset(unitName) {
        const topic = `ac/reset/${unitName}`;
        const btn = document.getElementById(`reset-btn-${unitName}`);

        if (btn && btn.classList.contains('resetting')) {
            console.warn(`[${unitName}] 이미 리셋 중입니다.`);
            return;
        }

        if (confirm(`정말로 ${unitName}을(를) 리셋하시겠습니까? (1분간 전원 차단)`)) {
            client.publish(topic, "reset", { qos: 1 });
            console.log(`📤 [${topic}] reset 명령 전송`);
            
            // 리셋 요청 즉시 버튼 색상을 변경하여 사용자에게 피드백 제공
            updateResetButtonState(unitName, 'resetting');
        }
    }


    /**
     * 리셋 버튼의 스타일과 텍스트를 업데이트합니다.
     * @param {string} unitName - 전체 유닛 이름
     * @param {string} state - 'resetting', 'done', or 'ready'
     */
    function updateResetButtonState(unitName, state) {
        const btn = document.getElementById(`reset-btn-${unitName}`);
        if (!btn) return;
        
        // 기존 타이머 클리어
        if (btn.dataset.timerId) {
            clearInterval(parseInt(btn.dataset.timerId));
            delete btn.dataset.timerId;
        }

        btn.classList.remove('resetting');
        btn.disabled = false;
        btn.textContent = "리셋";

        if (state === 'resetting') {
            btn.classList.add('resetting');
            btn.disabled = true;
            btn.textContent = "리셋 중 (60s)";
            
            // 카운트 다운 타이머 (선택 사항)
            let count = 60;
            const timer = setInterval(() => {
                count--;
                btn.textContent = `리셋 중 (${count}s)`;
                if (count <= 0) {
                    clearInterval(timer);
                    // 카운트 다운이 끝났어도, 실제 상태는 MQTT 메시지(done)를 기다림
                    btn.textContent = "완료 대기";
                }
            }, 1000);
            // 타이머 ID 저장
            btn.dataset.timerId = timer; 

        } else if (state === 'done') {
            btn.textContent = "완료 ✅";
            
            // 잠시 후 버튼을 정상 상태로 복구
            setTimeout(() => {
                btn.textContent = "리셋";
            }, 3000); 
        }
    }

    // ---------------- POPUP LOGIC ----------------
    // 팝업 업데이트
    function updatePopupContent(unitName) {
      const popup = document.querySelector(".popup");
      if (!popup) return;
      const e = temps[unitName]?.evap || "--";
      const s = temps[unitName]?.supply || "--";
      popup.querySelector(".evap").innerHTML = `증발기: <span class="${getColor('evap', e)}">${e}</span>°F`;
      popup.querySelector(".supply").innerHTML = `공급기: <span class="${getColor('supply', s)}">${s}</span>°F`;
    }

    // 팝업 표시 (수정 완료: 마커 아래 25px 위치 고정)
    function showPopup(unitName, marker) {
      if (activePopup) closePopup();

      const popup = document.createElement("div");
      popup.className = "popup";
      popup.dataset.unit = unitName;
      
      const displayId = unitName.replace('UNIT', '');

      const evap = temps[unitName]?.evap || "--";
      const supply = temps[unitName]?.supply || "--";

      popup.innerHTML = `
        <h4>
          ${displayId}
          <button class="close-btn" onclick="closePopup()">✕</button>
        </h4>
        <div class="temp evap">증발기: <span class="${getColor('evap', evap)}">${evap}</span>°F</div>
        <div class="temp supply">공급기: <span class="${getColor('supply', supply)}">${supply}</span>°F</div>
      `;

      // Use the marker's percentage position
      const markerLeft = parseFloat(marker.style.left);
      const markerTop = parseFloat(marker.style.top);
      
      popup.style.left = `${markerLeft}%`;
      popup.style.top = `${markerTop}%`; 
      
      // 마커 중앙(translateY(-50%))에서 시작하여 마커 크기(28px)를 고려해 아래로 25px만큼 이동합니다.
      // 이로써 확대/축소와 관계없이 팝업이 마커의 하단에 정확히 위치하게 됩니다.
      popup.style.transform = 'translate(-50%, 25px)'; 


      document.getElementById("layout").appendChild(popup);
      activePopup = popup;

      // Highlight the corresponding table row
      const row = document.getElementById(`row-${unitName}`);
      if (row) {
        row.classList.add("highlight");
        setTimeout(() => row.classList.remove("highlight"), 1500);
      }
    }

    function closePopup() {
      if (activePopup) {
        activePopup.remove();
        activePopup = null;
      }
    }
    
    // ---------------- ZOOM & DRAG LOGIC ----------------
    const layout = document.getElementById("layout");
    const mapWrapper = document.getElementById("mapWrapper");
    let scale = 1, posX = 0, posY = 0, startX, startY, dragging = false;

    mapWrapper.addEventListener("wheel", (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      scale = Math.min(Math.max(scale + delta, 0.5), 3);
      layout.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    });

    mapWrapper.addEventListener("mousedown", (e) => {
      dragging = true;
      mapWrapper.style.cursor = "grabbing";
      startX = e.clientX - posX;
      startY = e.clientY - posY;
    });

    mapWrapper.addEventListener("mousemove", (e) => {
      if (!dragging) return;
      posX = e.clientX - startX;
      posY = e.clientY - startY;
      layout.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    });

    mapWrapper.addEventListener("mouseup", () => {
      dragging = false;
      mapWrapper.style.cursor = "grab";
    });

    mapWrapper.addEventListener("mouseleave", () => {
      dragging = false;
      mapWrapper.style.cursor = "grab";
    });
  </script>
</body>
</html>