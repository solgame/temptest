<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>에어컨 모니터링 대시보드 (49유닛)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #eef2f7; margin: 0; }
    .container { max-width: 1900px; margin: auto; padding: 20px; }
    .header {
      text-align: center; margin-bottom: 20px; position: relative;
    }
    h1 { margin: 0; color: #333; font-weight: 600; }
    .refresh-btn {
      position: absolute; right: 10px; top: 10px;
      padding: 4px 10px; font-size: 0.8rem; cursor: pointer;
      border: none; border-radius: 5px;
      background: #007bff; color: white;
      transition: background 0.3s;
    }
    .refresh-btn:hover { background: #0056b3; }
    .sensors-grid {
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px;
    }
    .sensor-card {
      background: white; border-radius: 12px; padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      font-size: 0.95rem; transition: transform 0.2s;
    }
    .sensor-card:hover { transform: translateY(-3px); }
    .unit-title { font-weight: bold; margin-bottom: 8px; color: #444; font-size: 1rem; }
    .data-value { font-size: 1.1rem; font-weight: bold; }
    .blue { color: #1e90ff; }
    .black { color: #111; }
    .red { color: #ff4757; }
    .status {
      width: 10px; height: 10px; display: inline-block;
      border-radius: 50%; margin-left: 6px;
    }
    .online { background: #28a745; }
    .offline { background: #6c757d; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>❄️ 에어컨 모니터링 대시보드 (49유닛)</h1>
      <button class="refresh-btn" onclick="location.reload()">새로고침</button>
    </div>
    <div id="sensors-container" class="sensors-grid"></div>
  </div>

  <script>
    // ✅ 49유닛 생성
    const sensorUnits = [];
    for (let i = 1; i <= 49; i++) {
      sensorUnits.push({
        id: i,
        evap: { topic: `ac/temperature/evap-${i}`, name: `증발기-${i}` },
        supply: { topic: `ac/temperature/supply-${i}`, name: `공급기-${i}` }
      });
    }

    // ✅ HTML 카드 생성
    const container = document.getElementById('sensors-container');
    sensorUnits.forEach(unit => {
      const card = document.createElement('div');
      card.className = 'sensor-card';
      card.innerHTML = `
        <div class="unit-title">유닛 ${unit.id}</div>
        <div>${unit.evap.name}: <span id="temp-evap-${unit.id}">--</span>°F <span id="status-evap-${unit.id}" class="status offline"></span></div>
        <div>${unit.supply.name}: <span id="temp-supply-${unit.id}">--</span>°F <span id="status-supply-${unit.id}" class="status offline"></span></div>
      `;
      container.appendChild(card);
    });

    // ✅ MQTT 연결
    const client = mqtt.connect("wss://3f34159555984b35a539f803505dc858.s1.eu.hivemq.cloud:8884/mqtt", {
      username: "Goodmansystemllc",
      password: "Good7071**"
    });

    const lastUpdate = {};

    client.on("connect", () => {
      console.log("✅ MQTT 연결됨");
      sensorUnits.forEach(unit => {
        client.subscribe(unit.evap.topic);
        client.subscribe(unit.supply.topic);
      });
    });

    function getColorClass(role, temp) {
      if (role === "evap") {
        if (temp < 32) return "blue";
        else if (temp <= 65) return "black";
        else return "red";
      } else if (role === "supply") {
        if (temp <= 76) return "blue";
        else if (temp <= 80) return "black";
        else return "red";
      }
      return "black";
    }

    client.on("message", (topic, message) => {
      try {
        const data = JSON.parse(message.toString());
        let role = topic.includes("evap") ? "evap" : "supply";
        let id = topic.split("-")[1];
        const key = `${role}-${id}`;

        const temp = data.temp_f;
        const tempEl = document.getElementById(`temp-${key}`);
        tempEl.textContent = temp.toFixed(1);
        tempEl.className = `data-value ${getColorClass(role, temp)}`;

        document.getElementById(`status-${key}`).className = 'status online';
        lastUpdate[key] = Date.now();
      } catch (e) {
        console.error("JSON 파싱 오류:", e);
      }
    });

    // ✅ 오프라인 감지
    setInterval(() => {
      const now = Date.now();
      sensorUnits.forEach(unit => {
        ["evap", "supply"].forEach(role => {
          const key = `${role}-${unit.id}`;
          if (!lastUpdate[key] || now - lastUpdate[key] > 30000) {
            document.getElementById(`status-${key}`).className = 'status offline';
            document.getElementById(`temp-${key}`).textContent = "--";
          }
        });
      });
    }, 10000);
  </script>
</body>
</html>
