<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>에어컨 모니터링 대시보드 (49유닛)</title>
  
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="unitLocations.js"></script> <style>
    /* 폰트 및 배경 */
    body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; color: #333; }
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

    /* 컨테이너 및 헤더 */
    .container { max-width: 1900px; margin: auto; padding: 25px; }
    .header { text-align: left; margin-bottom: 30px; position: relative; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
    h1 { margin: 0; color: #2c3e50; font-weight: 700; font-size: 1.8rem; }
    .refresh-btn {
      position: absolute; right: 0; top: 5px;
      padding: 6px 15px; font-size: 0.9rem; cursor: pointer;
      border: none; border-radius: 6px;
      background: #3498db; color: white;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: background 0.3s, transform 0.1s;
    }
    .refresh-btn:hover { background: #2980b9; transform: translateY(-1px); }

    /* 그리드 */
    .sensors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }

    /* 유닛 카드 */
    .sensor-card {
      background: white; border-radius: 12px; padding: 20px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      font-size: 0.9rem; transition: transform 0.3s, box-shadow 0.3s;
      border-left: 5px solid #3498db;
      overflow: hidden;
    }
    .sensor-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }

    .unit-info { margin-bottom: 15px; }
    .unit-title {
        font-weight: 700; color: #2c3e50; font-size: 1.2rem;
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 4px;
    }
    .unit-location { font-size: 0.85rem; color: #7f8c8d; }

    /* 센서 데이터 영역 */
    .sensor-data-area {
        display: flex; gap: 10px;
        flex-direction: column;
    }

    .sensor-entry {
        padding: 8px 0;
        border-top: 1px solid #ecf0f1;
        display: flex; justify-content: space-between;
        align-items: center;
    }
    .sensor-entry:first-child { border-top: none; }

    .sensor-name { font-weight: 600; color: #555; font-size: 0.9rem; }
    .data-display { display: flex; align-items: center; }

    .data-value {
        font-size: 1.4rem;
        font-weight: 700;
        line-height: 1;
        margin-right: 5px;
    }

    /* 색상 클래스 */
    .blue { color: #3498db; }
    .black { color: #2c3e50; }
    .red { color: #e74c3c; }

    /* 상태 표시 */
    .status {
      width: 10px; height: 10px; display: inline-block;
      border-radius: 50%; margin-left: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .online { background: #2ecc71; }
    .offline { background: #95a5a6; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>❄️ 에어컨 모니터링 대시보드 (49유닛)</h1>
      <button class="refresh-btn" onclick="location.reload()">새로고침</button>
    </div>
    <div id="sensors-container" class="sensors-grid"></div>
  </div>

  <script>
    // unitLocations 객체는 이미 unitLocations.js 파일을 통해 로드되었습니다.
    
    // ✅ 49유닛 생성 (위치 정보 포함)
    const sensorUnits = [];
    for (let i = 1; i <= 49; i++) {
      sensorUnits.push({
        id: i,
        // unitLocations.js에서 위치 정보를 가져오고, 없으면 '위치 미지정'으로 표시
        location: unitLocations[i] || '위치 미지정', 
        evap: { topic: `ac/temperature/evap-${i}`, name: `증발기` },
        supply: { topic: `ac/temperature/supply-${i}`, name: `공급기` }
      });
    }

    // ✅ HTML 카드 생성 (세련된 디자인 및 데이터 연동 ID 포함)
    const container = document.getElementById('sensors-container');
    sensorUnits.forEach(unit => {
      const card = document.createElement('div');
      card.className = 'sensor-card';
      card.innerHTML = `
        <div class="unit-info">
            <div class="unit-title">
                유닛 ${unit.id}
            </div>
            <div class="unit-location">${unit.location}</div>
        </div>
        <div class="sensor-data-area">
            <div class="sensor-entry">
                <span class="sensor-name">${unit.evap.name}</span>
                <div class="data-display">
                    <span id="temp-evap-${unit.id}" class="data-value">--</span>°F
                    <span id="status-evap-${unit.id}" class="status offline"></span>
                </div>
            </div>
            <div class="sensor-entry">
                <span class="sensor-name">${unit.supply.name}</span>
                <div class="data-display">
                    <span id="temp-supply-${unit.id}" class="data-value">--</span>°F
                    <span id="status-supply-${unit.id}" class="status offline"></span>
                </div>
            </div>
        </div>
      `;
      container.appendChild(card);
    });

    // ✅ MQTT 연결
    const client = mqtt.connect("wss://3f34159555984b35a539f803505dc858.s1.eu.hivemq.cloud:8884/mqtt", {
      username: "Goodmansystemllc",
      password: "Good7071**"
    });

    const lastUpdate = {};

    client.on("connect", () => {
      console.log("✅ MQTT 연결됨");
      sensorUnits.forEach(unit => {
        client.subscribe(unit.evap.topic);
        client.subscribe(unit.supply.topic);
      });
    });

    function getColorClass(role, temp) {
      if (role === "evap") {
        if (temp < 32) return "blue";
        else if (temp <= 65) return "black";
        else return "red";
      } else if (role === "supply") {
        if (temp <= 76) return "blue";
        else if (temp <= 80) return "black";
        else return "red";
      }
      return "black";
    }

    client.on("message", (topic, message) => {
      try {
        const data = JSON.parse(message.toString());
        let role = topic.includes("evap") ? "evap" : "supply";
        let id = topic.split("-")[1];
        const key = `${role}-${id}`;

        const temp = data.temp_f;
        const tempEl = document.getElementById(`temp-${key}`);
        tempEl.textContent = temp.toFixed(1);
        tempEl.className = `data-value ${getColorClass(role, temp)}`; 

        document.getElementById(`status-${key}`).className = 'status online';
        lastUpdate[key] = Date.now();
      } catch (e) {
        console.error("JSON 파싱 오류:", e);
      }
    });

    // ✅ 오프라인 감지
    setInterval(() => {
      const now = Date.now();
      sensorUnits.forEach(unit => {
        ["evap", "supply"].forEach(role => {
          const key = `${role}-${unit.id}`;
          if (!lastUpdate[key] || now - lastUpdate[key] > 30000) {
            document.getElementById(`status-${key}`).className = 'status offline';
            document.getElementById(`temp-${key}`).textContent = "--";
            document.getElementById(`temp-${key}`).className = 'data-value black'; 
          }
        });
      });
    }, 10000);
  </script>
</body>
</html>