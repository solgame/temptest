<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>에어컨 모니터링 대시보드 (49유닛)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f2f5; }
    .container { max-width: 1900px; margin: auto; }
    .header { text-align: center; margin: 20px; }
    .sensors-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    .sensor-card {
      background: white; border-radius: 8px; padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); font-size: 0.9rem;
    }
    .unit-title { font-weight: bold; margin-bottom: 5px; }
    .data-value { font-size: 1.1rem; font-weight: bold; }
    .blue { color: #1e90ff; }
    .red { color: #ff4757; }
    .status { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-left: 5px; }
    .online { background: #28a745; }
    .offline { background: #6c757d; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>❄️ 에어컨 모니터링 대시보드 (49유닛)</h1>
    </div>
    <div id="sensors-container" class="sensors-grid"></div>
  </div>

  <script>
    // 49유닛 생성
    const sensorUnits = [];
    for (let i = 1; i <= 49; i++) {
      sensorUnits.push({
        id: i,
        evap: { topic: `ac/temperature/evap-${i}`, name: `증발기-${i}` },
        supply: { topic: `ac/temperature/supply-${i}`, name: `공급기-${i}` }
      });
    }

    // HTML 카드 생성
    const container = document.getElementById('sensors-container');
    sensorUnits.forEach(unit => {
      const card = document.createElement('div');
      card.className = 'sensor-card';
      card.innerHTML = `
        <div class="unit-title">유닛 ${unit.id}</div>
        <div>${unit.evap.name}: <span id="temp-evap-${unit.id}">--</span>°F <span id="status-evap-${unit.id}" class="status offline"></span></div>
        <div>${unit.supply.name}: <span id="temp-supply-${unit.id}">--</span>°F <span id="status-supply-${unit.id}" class="status offline"></span></div>
      `;
      container.appendChild(card);
    });

    // 마지막 수신 시간 기록
    const lastUpdate = {};

    // MQTT 연결
    const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt", {
      username: "goodmansystemllc@mail.com",
      password: "Sol7071**"
    });

    client.on("connect", () => {
      console.log("✅ MQTT 연결됨");
      sensorUnits.forEach(unit => {
        client.subscribe(unit.evap.topic);
        client.subscribe(unit.supply.topic);
      });
    });

    client.on("message", (topic, message) => {
      const data = JSON.parse(message.toString());
      let role = topic.includes("evap") ? "evap" : "supply";
      let id = topic.split("-")[1];
      const key = `${role}-${id}`;

      const temp = data.temp_f;
      const tempEl = document.getElementById(`temp-${key}`);
      tempEl.textContent = temp.toFixed(1);
      tempEl.className = (temp >= 32 && temp <= 73) ? 'data-value blue' : 'data-value red';

      document.getElementById(`status-${key}`).className = 'status online';
      lastUpdate[key] = Date.now();
    });

    // 오프라인 감지 (30초 이상 업데이트 없으면 offline 처리)
    setInterval(() => {
      const now = Date.now();
      sensorUnits.forEach(unit => {
        ["evap", "supply"].forEach(role => {
          const key = `${role}-${unit.id}`;
          if (!lastUpdate[key] || now - lastUpdate[key] > 30000) {
            document.getElementById(`status-${key}`).className = 'status offline';
            document.getElementById(`temp-${key}`).textContent = "--";
          }
        });
      });
    }, 10000);
  </script>
</body>
</html>
